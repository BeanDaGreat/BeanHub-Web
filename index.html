import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from 'firebase/firestore';
import { 
  Terminal, 
  Settings, 
  Copy, 
  Check, 
  Lock, 
  Globe,
  Disc,
  Zap,
  Waves,
  ShieldCheck,
  ZapOff,
  Users,
  Layers,
  Activity,
  ChevronRight,
  Monitor
} from 'lucide-react';

// --- CENTRAL CONFIGURATION ---
// Edit these values to update the site content easily
const CONFIG = {
  APP_ID: typeof __app_id !== 'undefined' ? __app_id : 'beanhub-prod',
  ADMIN_PASSWORD: '@lesam625',
  DISCORD_URL: 'https://discord.gg/beanhub',
  LOADER_SCRIPT: `loadstring(game:HttpGet("https://raw.githubusercontent.com/BeanHub/Main/main/loader.lua"))()`,
  INITIAL_STATUS: {
    wave: true,
    delta: true,
    fluxus: false,
    updateMsg: "System Optimal",
    lastUpdated: Date.now()
  }
};

// --- FIREBASE INITIALIZATION ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  // Authentication & Role State
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [isAuthLoading, setIsAuthLoading] = useState(true);
  
  // UI State
  const [showLogin, setShowLogin] = useState(false);
  const [password, setPassword] = useState('');
  const [copied, setCopied] = useState(false);
  const [activeUsers, setActiveUsers] = useState(1420);
  const [isBooting, setIsBooting] = useState(true);
  
  // Real-time Status State
  const [status, setStatus] = useState(CONFIG.INITIAL_STATUS);

  // --- LIFECYCLE: UI EFFECTS ---
  useEffect(() => {
    const userInterval = setInterval(() => {
      setActiveUsers(prev => prev + Math.floor(Math.random() * 7) - 3);
    }, 3000);
    
    const bootTimer = setTimeout(() => setIsBooting(false), 800);
    
    return () => {
      clearInterval(userInterval);
      clearTimeout(bootTimer);
    };
  }, []);

  // --- LIFECYCLE: AUTHENTICATION (RULE 3) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth initialization failed:", err);
      } finally {
        setIsAuthLoading(false);
      }
    };
    
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  // --- LIFECYCLE: FIRESTORE SYNC (RULE 1 & 2) ---
  useEffect(() => {
    if (!user || isAuthLoading) return;
    
    const statusDocRef = doc(db, 'artifacts', CONFIG.APP_ID, 'public', 'data', 'system', 'status');
    
    const unsubscribe = onSnapshot(statusDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setStatus(docSnap.data());
      } else {
        // Initialize document if it doesn't exist in the specific path
        setDoc(statusDocRef, CONFIG.INITIAL_STATUS);
      }
    }, (err) => {
      console.error("Firestore sync interrupted:", err);
    });

    return () => unsubscribe();
  }, [user, isAuthLoading]);

  // --- HANDLERS ---
  const updateGlobalStatus = async (updates) => {
    if (!isAdmin || !user) return;
    const statusDocRef = doc(db, 'artifacts', CONFIG.APP_ID, 'public', 'data', 'system', 'status');
    try {
      await updateDoc(statusDocRef, { 
        ...updates,
        lastUpdated: Date.now()
      });
    } catch (err) {
      console.error("Failed to update system status:", err);
    }
  };

  const handleLogin = (e) => {
    e.preventDefault();
    if (password === CONFIG.ADMIN_PASSWORD) { 
      setIsAdmin(true);
      setShowLogin(false);
      setPassword('');
    } else {
      setPassword('');
      // Visual feedback for wrong password could be added here
    }
  };

  const copyToClipboard = useCallback(() => {
    const textArea = document.createElement("textarea");
    textArea.value = CONFIG.LOADER_SCRIPT;
    // Ensure element is not visible but part of DOM for execCommand
    Object.assign(textArea.style, {
      position: "fixed",
      left: "-9999px",
      top: "0"
    });
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      if (document.execCommand('copy')) {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      }
    } catch (err) {
      console.error("Unable to copy to clipboard", err);
    }
    document.body.removeChild(textArea);
  }, []);

  // --- MEMOIZED CALCULATIONS ---
  const securityScore = useMemo(() => {
    const score = (status.wave ? 45 : 0) + (status.delta ? 45 : 0) + (status.fluxus ? 8.4 : 2);
    return score.toFixed(1);
  }, [status]);

  // --- RENDER: LOADING STATE ---
  if (isBooting) {
    return (
      <div className="min-h-screen bg-[#020402] flex items-center justify-center font-mono text-emerald-500">
        <div className="space-y-2 text-center">
          <p className="animate-pulse tracking-tighter">_ INITIALIZING BEANHUB_CORE...</p>
          <div className="w-48 h-1 bg-white/5 rounded-full overflow-hidden mx-auto">
            <div className="h-full bg-emerald-500 animate-[loading_1s_ease-in-out_infinite]" />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#020402] text-slate-200 font-sans selection:bg-emerald-500/30 overflow-x-hidden">
      {/* Background Grid Layer */}
      <div className="fixed inset-0 pointer-events-none opacity-20 z-0" 
           style={{backgroundImage: `radial-gradient(#10b981 0.5px, transparent 0.5px)`, backgroundSize: '24px 24px'}}></div>
      
      {/* Navigation Bar */}
      <nav className="fixed top-0 w-full z-[60] px-4 py-4 md:px-6 md:py-6">
        <div className="max-w-7xl mx-auto flex items-center justify-between bg-black/40 backdrop-blur-xl border border-white/5 rounded-2xl px-4 md:px-8 py-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-black shadow-lg shadow-emerald-500/20">
              <Terminal size={20} />
            </div>
            <span className="font-black text-xl tracking-tighter uppercase">Bean<span className="text-emerald-500">Hub</span></span>
          </div>
          
          <div className="hidden lg:flex gap-8 text-[10px] font-black uppercase tracking-widest text-slate-500">
            {['status', 'features', 'script'].map(link => (
              <a key={link} href={`#${link}`} className="hover:text-emerald-400 transition-colors uppercase">{link}</a>
            ))}
            <button onClick={() => setShowLogin(true)} className="hover:text-emerald-400 transition-colors flex items-center gap-2">
              <Lock size={12} /> {isAdmin ? 'Root: Active' : 'Dev Login'}
            </button>
          </div>

          <div className="flex items-center gap-4">
             <div className="hidden sm:flex flex-col items-end leading-none">
                <span className="text-[10px] font-black text-emerald-500">{activeUsers.toLocaleString()}</span>
                <span className="text-[8px] font-bold text-slate-600 uppercase tracking-tighter">Live Sessions</span>
             </div>
             <a href={CONFIG.DISCORD_URL} target="_blank" rel="noreferrer" className="bg-emerald-500 text-black px-6 py-2 rounded-lg text-xs font-black uppercase tracking-wider hover:bg-emerald-400 transition-all shadow-lg shadow-emerald-500/10">Discord</a>
          </div>
        </div>
      </nav>

      {/* Hero Section */}
      <header className="pt-48 md:pt-56 pb-20 md:pb-32 px-6 text-center relative overflow-hidden">
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[1200px] h-[600px] bg-emerald-500/5 blur-[140px] -z-10 rounded-full" />
        <div className="inline-flex items-center gap-2 px-4 py-2 mb-8 text-[10px] font-black tracking-widest text-emerald-400 bg-emerald-400/5 rounded-full border border-emerald-400/10">
          <Activity size={12} className="animate-pulse" />
          V4.0 CLOUD ARCHITECTURE
        </div>
        <h1 className="text-5xl md:text-9xl font-black tracking-tighter mb-8 leading-[0.85]">
          The Industry <br /><span className="text-transparent bg-clip-text bg-gradient-to-r from-emerald-300 via-emerald-500 to-emerald-800 uppercase">Standard.</span>
        </h1>
        <p className="max-w-xl mx-auto text-slate-400 text-base md:text-lg mb-12 font-medium">
          Premium infrastructure providing instant script execution and unmatched stability across all platforms.
        </p>
        <div className="flex flex-col sm:flex-row justify-center gap-4">
          <button 
            onClick={() => document.getElementById('script')?.scrollIntoView({ behavior: 'smooth' })} 
            className="bg-emerald-500 text-black px-12 py-5 rounded-2xl font-black text-xl shadow-xl shadow-emerald-500/30 hover:scale-[1.02] hover:bg-emerald-400 active:scale-95 transition-all"
          >
            Launch Loader
          </button>
          <button 
            onClick={() => document.getElementById('status')?.scrollIntoView({ behavior: 'smooth' })}
            className="bg-white/5 border border-white/10 px-12 py-5 rounded-2xl font-black text-xl hover:bg-white/10 transition-all"
          >
            Check Status
          </button>
        </div>
      </header>

      {/* Grid Content Section */}
      <main id="status" className="max-w-7xl mx-auto px-6 py-20 border-y border-white/[0.03]">
        <div className="grid lg:grid-cols-4 gap-8">
          
          {/* Sidebar Admin Controls */}
          <div className={`lg:col-span-1 transition-all duration-500 ${isAdmin ? 'opacity-100' : 'opacity-20 grayscale pointer-events-none hidden lg:block'}`}>
            <div className="bg-white/5 border border-white/10 rounded-[32px] p-8 sticky top-32 backdrop-blur-sm">
              <div className="flex items-center gap-3 mb-8">
                <Settings className="text-emerald-500 animate-spin-slow" size={20} />
                <h3 className="font-bold uppercase tracking-tight">Root Controls</h3>
              </div>
              <div className="space-y-6">
                {['wave', 'delta', 'fluxus'].map(key => (
                  <div key={key} className="flex items-center justify-between group">
                    <span className="text-sm font-bold capitalize group-hover:text-emerald-400 transition-colors">{key}</span>
                    <button 
                      onClick={() => updateGlobalStatus({ [key]: !status[key] })}
                      className={`w-12 h-6 rounded-full transition-all relative ${status[key] ? 'bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.3)]' : 'bg-white/10'}`}
                    >
                      <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${status[key] ? 'left-7' : 'left-1'}`} />
                    </button>
                  </div>
                ))}
                <div className="pt-6 border-t border-white/5">
                  <label className="text-[10px] font-black text-slate-500 uppercase block mb-2">Global Broadcast</label>
                  <input 
                    type="text" 
                    value={status.updateMsg}
                    onChange={(e) => updateGlobalStatus({ updateMsg: e.target.value })}
                    className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-emerald-500 transition-colors"
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Main Network Status */}
          <div className="lg:col-span-3 grid md:grid-cols-3 gap-6">
            <div className="md:col-span-3 flex flex-col md:flex-row md:items-center justify-between gap-4 px-2 mb-2">
              <h2 className="text-4xl font-black tracking-tight uppercase italic">Network <span className="text-emerald-500">Relay</span></h2>
              <div className="flex items-center gap-4 bg-emerald-500/5 px-6 py-3 rounded-2xl border border-emerald-500/10">
                <div className="flex flex-col">
                  <span className="text-[8px] font-black text-slate-500 uppercase tracking-widest">Live Pulse</span>
                  <span className="text-xs font-bold text-emerald-400">{status.updateMsg}</span>
                </div>
              </div>
            </div>

            <StatusCard title="Wave 2.1" active={status.wave} Icon={Waves} desc="Next-gen detection bypass for PC." />
            <StatusCard title="Delta Mobile" active={status.delta} Icon={Disc} desc="Standard Android framework support." />
            <StatusCard title="Fluxus Cloud" active={status.fluxus} Icon={Zap} desc="Legacy relay / Maintenance." />
            
            {/* Stability Index Card */}
            <div className="md:col-span-3 bg-gradient-to-br from-emerald-500/[0.07] to-transparent border border-emerald-500/20 rounded-[32px] p-10 flex flex-col md:flex-row items-center justify-between gap-8">
               <div className="text-center md:text-left">
                  <div className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1">Stability Index</div>
                  <div className="text-5xl font-black italic">{securityScore}%</div>
                  <div className="text-xs text-slate-500 font-bold mt-2 uppercase tracking-tight italic">Global infrastructure health report.</div>
               </div>
               <div className="flex gap-4 items-end h-16">
                  {[20, 50, 80, 95].map(threshold => (
                    <div 
                      key={threshold} 
                      className={`w-1.5 rounded-full transition-all duration-700 ${Number(securityScore) >= threshold ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-white/10'}`} 
                      style={{ height: `${(threshold / 100) * 100}%` }}
                    />
                  ))}
               </div>
            </div>
          </div>
        </div>
      </main>

      {/* Features Grid */}
      <section id="features" className="max-w-7xl mx-auto px-6 py-32">
        <div className="text-center mb-20">
          <h2 className="text-4xl font-black mb-4 tracking-tighter uppercase italic">System <span className="text-emerald-500">Core</span></h2>
          <p className="text-slate-500 max-w-lg mx-auto font-medium uppercase text-[10px] tracking-[0.3em]">Engineering excellence for the modern exploiter.</p>
        </div>
        <div className="grid md:grid-cols-3 gap-8 md:gap-12">
          <FeatureCard Icon={ShieldCheck} title="Kernel Guard" desc="Advanced obfuscation that mimics legitimate game traffic to evade modern AC systems." />
          <FeatureCard Icon={Layers} title="Cross-Platform" desc="Universal loader logic that detects your environment and optimizes for CPU/GPU." />
          <FeatureCard Icon={Users} title="Rapid Response" desc="24/7 devops monitoring ensuring script patches are pushed within minutes of updates." />
        </div>
      </section>

      {/* Code / Script Snippet */}
      <section id="script" className="max-w-5xl mx-auto px-6 py-20">
        <div className="relative group">
          <div className="absolute -inset-1 bg-gradient-to-r from-emerald-500 to-emerald-900 rounded-[42px] blur-xl opacity-20 group-hover:opacity-30 transition duration-1000"></div>
          <div className="relative bg-[#050705] border border-white/5 rounded-[40px] overflow-hidden shadow-2xl">
            <div className="px-6 md:px-10 py-8 border-b border-white/5 flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white/[0.01]">
              <div className="flex items-center gap-3">
                <div className="flex gap-1.5 mr-4">
                  <div className="w-2.5 h-2.5 bg-red-500/40 rounded-full" />
                  <div className="w-2.5 h-2.5 bg-yellow-500/40 rounded-full" />
                  <div className="w-2.5 h-2.5 bg-green-500/40 rounded-full" />
                </div>
                <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest font-mono">Loader.lua</span>
              </div>
              <button 
                onClick={copyToClipboard}
                className="bg-emerald-500 text-black px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-emerald-400 transition-all active:scale-95 shadow-lg shadow-emerald-500/20"
              >
                {copied ? <Check size={14} className="animate-bounce" /> : <Copy size={14} />}
                {copied ? 'Success' : 'Copy Script'}
              </button>
            </div>
            <div className="p-8 md:p-12 font-mono text-xs md:text-sm leading-loose text-emerald-400/90 overflow-x-auto custom-scrollbar">
              <pre className="selection:bg-emerald-500/40 whitespace-pre-wrap md:whitespace-pre">
{`-- [[ BEANHUB UNIVERSAL ]] --
-- Auto-detection enabled...
-- Syncing cloud variables...

${CONFIG.LOADER_SCRIPT}`}
              </pre>
            </div>
          </div>
        </div>
      </section>

      {/* Dev Login Modal */}
      {showLogin && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-black/95 backdrop-blur-md transition-all duration-300">
          <div className="bg-[#0a0a0a] border border-white/10 rounded-[40px] p-8 md:p-12 w-full max-w-md shadow-2xl relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
            <button onClick={() => setShowLogin(false)} className="absolute top-8 right-8 text-slate-500 hover:text-white transition-colors">âœ•</button>
            <h3 className="text-3xl font-black mb-2 flex items-center gap-3 italic uppercase">
              <Lock className="text-emerald-500" /> Root Access
            </h3>
            <p className="text-slate-500 text-[10px] mb-10 font-bold uppercase tracking-[0.2em]">Developer credentials required for sync.</p>
            <form onSubmit={handleLogin} className="space-y-6">
              <input 
                type="password" 
                placeholder="Terminal Key" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-5 focus:outline-none focus:border-emerald-500 transition-all font-mono placeholder:text-slate-700 text-center tracking-widest"
                autoFocus
              />
              <button type="submit" className="w-full bg-emerald-500 text-black py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-emerald-400 transition-all shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2">
                Authorize <ChevronRight size={16} />
              </button>
            </form>
          </div>
        </div>
      )}

      {/* Footer Branding */}
      <footer className="border-t border-white/5 py-32 px-6 mt-20 relative overflow-hidden">
        <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-emerald-500/5 blur-[120px] -z-10 rounded-full" />
        <div className="max-w-7xl mx-auto flex flex-col items-center gap-12">
          <div className="flex flex-col items-center gap-4">
            <div className="w-16 h-16 bg-white/5 rounded-[24px] flex items-center justify-center text-emerald-500 border border-white/10 group hover:border-emerald-500/50 transition-colors">
              <Monitor size={32} className="group-hover:scale-110 transition-transform" />
            </div>
            <span className="font-black text-2xl tracking-tighter text-white uppercase italic">BeanHub <span className="text-emerald-500">Relay</span></span>
          </div>
          <div className="text-[10px] font-black uppercase tracking-[0.3em] text-slate-600 text-center max-w-md leading-relaxed">
            The world's leading execution network. <br /> Developed with precision. 2026.
          </div>
          <div className="flex gap-10">
            <a href={CONFIG.DISCORD_URL} className="text-slate-500 hover:text-emerald-500 transition-all hover:scale-125"><Disc size={24} /></a>
            <a href="#" className="text-slate-500 hover:text-emerald-500 transition-all hover:scale-125"><Globe size={24} /></a>
          </div>
        </div>
      </footer>

      <style>{`
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes loading { 0% { width: 0%; transform: translateX(-100%); } 50% { width: 100%; transform: translateX(0); } 100% { width: 0%; transform: translateX(100%); } }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b98133; border-radius: 10px; }
      `}</style>
    </div>
  );
}

// --- SUB-COMPONENTS ---

function StatusCard({ title, active, Icon, desc }) {
  return (
    <div className={`bg-white/5 border border-white/10 rounded-[32px] p-8 transition-all duration-500 group hover:bg-white/[0.08] hover:border-emerald-500/30 ${!active && 'opacity-40 grayscale blur-[0.5px]'}`}>
      <div className="flex justify-between items-start mb-10">
        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center transition-all ${active ? 'bg-emerald-500/10 text-emerald-500 group-hover:scale-110 shadow-lg shadow-emerald-500/5' : 'bg-red-500/10 text-red-500'}`}>
          {active ? (Icon && <Icon size={28} />) : <ZapOff size={28} />}
        </div>
        <div className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest border transition-all ${active ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400 group-hover:bg-emerald-500 group-hover:text-black' : 'bg-red-500/10 border-red-500/30 text-red-400'}`}>
          {active ? 'Relay Active' : 'Offline'}
        </div>
      </div>
      <h4 className="font-black text-2xl mb-2 italic tracking-tight uppercase group-hover:text-emerald-400 transition-colors">{title}</h4>
      <p className="text-[10px] text-slate-500 leading-relaxed font-bold uppercase tracking-tight">{desc}</p>
    </div>
  );
}

function FeatureCard({ Icon, title, desc }) {
  return (
    <div className="bg-white/[0.03] border border-white/5 rounded-[40px] p-10 hover:bg-white/[0.06] transition-all group hover:border-emerald-500/20">
      <div className="w-16 h-16 bg-emerald-500/10 rounded-2xl flex items-center justify-center text-emerald-500 mb-8 group-hover:scale-110 transition-transform group-hover:bg-emerald-500/20">
        <Icon size={32} />
      </div>
      <h4 className="text-2xl font-black mb-4 uppercase tracking-tighter italic">{title}</h4>
      <p className="text-slate-400 text-sm font-medium leading-relaxed">{desc}</p>
    </div>
  );
}
